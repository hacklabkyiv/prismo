{% extends "layout.html" %}
{% block content %}
<div class="container-fluid px-md-5">
  <div class="container-fluid px-md-5">
    <div class="row">
      <div class="card">
        <div class="card-header"> Add new RFID Reader Device: </div>
        <div class="card-body">
          <div class="input-group mb-3">
            <button class="btn btn-primary" type="submit"
              onclick="addDevice(document.getElementById('device_name').value)">
              <i class="bi bi-database-add"></i> Add device </button>
            <input type="text" class="form-control" id="device_name" placeholder="Device Name">
          </div>
        </div>
      </div>
    </div>
    <div class="py-3">
      <div class="accordion" id="devicesList"></div>
    </div>
  </div>
  <script>
    fetch('/api/devices').then(response => response.json())
      .then(data => generateAccordionItems(data))
      .catch(error => console.error('Error fetching data:', error));

    function generateAccordionItems(devices) {
      const accordionItemsHTML = [];
      for (const device of devices) {
        const accordionItemHTML = `
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse-${device.id}" aria-expanded="false" aria-controls="flush-collapse-${device.id}">
                <i class="bi bi-phone-vibrate-fill"></i> | ${device.name}
              </button>
            </h2>

            <div id="flush-collapse-${device.id}" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
              <div class="accordion-body">
                <div class="d-flex justify-content-between align-items-center">

                  <div class="me-3">
                    Device id: ${device.id}, Device type: ${device.type}
                  </div>

                  <div>
                    <button type="button" class="btn btn-primary me-3">Flash Connected Device</button>
                    <button type="button" class="btn btn-danger" onclick="removeDevice('${device.id}')">Remove Device</button>
                  </div>

                </div>
              </div>
            </div>
          </div>
                `;
        accordionItemsHTML.push(accordionItemHTML);
      }
      const devicesListElement = document.getElementById('devicesList');
      devicesListElement.innerHTML = accordionItemsHTML.join('');
    }

    function addDevice(deviceName) {
      // Generate random UUID for device ID
      const deviceId = crypto.randomUUID();
      // Prepare device data
      const deviceData = {
        "device_name": deviceName,
        "device_id": deviceId,
        "device_type": "tool"
      };
      // Make API call to add device
      fetch('/api/devices', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(deviceData)
      }).then(response => {
        // Check if response status code is 201 (Created)
        if (response.status === 201) {
          alert('Device added successfully!');
          refreshDevicesList();
        } else {
          alert('Error adding device. Please try again later.');
        }
      }).catch(error => {
        console.error('Error adding device:', error);
        alert('Error adding device. Please try again later.');
      });
    }

    function removeDevice(deviceId) {
      fetch(`/api/devices/${deviceId}`, {
        method: 'DELETE',
      }).then(response => {
        if (response.status === 200) {
          alert('Device removed successfully!');
          refreshDevicesList();
        } else {
          alert('Error removing device. Please try again later.');
        }
      }).catch(error => {
        console.error('Error removing device:', error);
        alert('Error removing device. Please try again later.');
      });
    }

    function refreshDevicesList() {
      fetch('/api/devices')
        .then(response => response.json())
        .then(data => generateAccordionItems(data))
        .catch(error => console.error('Error fetching data:', error));
    }
  </script>
</div>
{% endblock %}