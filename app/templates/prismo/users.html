{% extends "layout.html" %}
{% block content %}
<div class="container-fluid px-md-5">
    <div class="row">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Add last used RFID card as new user</h5>
                <p class="card-text">Card: <strong>{{ latest_key[:8] + "..." + latest_key[-8:]}}</strong> was triggered at: <strong>20:57AM</strong></p>
                <div class="input-group mb-3">
                    <button class="btn btn-primary" type="submit" onclick="addUser('{{ latest_key }}', document.getElementById('user_name').value)" ><i class="bi bi-person-add"></i> Add User</button>  
                    <input type="text" class="form-control" id="user_name" placeholder="User Name">
                </div>
            </div>
        </div>
    </div>
    <div class="py-3">
        <table id="userTable" class="table table-striped table-bordered" style="width:100%">
        </table>
    </div>
</div>

<script>
  async function deleteUser(userKey) {
    try {
      const response = await fetch(`/api/users/${userKey}`, { method: 'DELETE' });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      console.log('Device successfully deleted');
    } catch (error) {
      console.error('Error:', error);
    }
  }

  async function fetchData() {
    try {
      const response = await fetch('/api/users')
      const data = await response.json()
      const tableData = data.map(user => {
        return {
          name: user.user_name,
          key: user.user_key,
          ...user.permissions.reduce((acc, obj) => {
            acc[obj.device_name] = {
              allowed: obj.allowed,
              device_id: obj.device_id
            }
            return acc
          }, {}),
          operation: '<button class="btn btn-sm btn-danger" onclick="deleteUser(\'' + user.user_key + '\')">Delete</button>'
        }
      })

      $('#userTable').DataTable({
        data: tableData,
        columns: Object.keys(tableData[0]).map(key => {
          return {
            data: (row) => {
              const value = row[key]
              return typeof value === 'string' ? value : `<input type="checkbox" ${value?.allowed && "checked"}>`
            },
            // Capitalize first letter of key
            title: key.charAt(0).toUpperCase() + key.slice(1)
          }
        })
      })

    } catch (error) {
      console.error('Error:', error)
    }
  }

$(document).ready(function() {
  fetchData()
 })
</script>

{% endblock %}
